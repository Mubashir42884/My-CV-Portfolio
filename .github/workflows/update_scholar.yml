name: Update Scholar Data

on:
  schedule:
    # Run once per week (every Monday at 2 AM UTC) to reduce rate limiting
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allows you to click "Run Now" manually

permissions:
  contents: write

jobs:
  update-scholar:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: |
          pip install scholarly
          pip install free-proxy
          
      - name: Run Scraper Script
        id: scraper
        continue-on-error: true
        run: |
          echo "Starting Scholar data fetch..."
          python scripts/fetch_scholar.py
        
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/scholar.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in scholar.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in scholar.json"
          fi
        
      - name: Commit and Push Changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/scholar.json
          git commit -m "ðŸ¤– Auto-update: Scholar publications data [skip ci]"
          git push
          echo "âœ“ Changes committed and pushed successfully"
      
      - name: No changes to commit
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "â„¹ï¸ No updates needed - scholar.json is already up to date"
      
      - name: Summary
        if: always()
        run: |
          echo "## Scholar Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.scraper.outcome }}" == "success" ]; then
            echo "âœ… **Scraper Status:** Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Scraper Status:** Failed (existing data preserved)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "ðŸ“ **Changes:** New data committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ **Changes:** No updates needed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next scheduled run:** Next Monday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY